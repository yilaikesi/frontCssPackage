<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="https://cdn.socket.io/4.4.1/socket.io.min.js"></script>
</head>
<style>
    .main-video {
        flex: 1;
        height: 300px;
    }
    video {
        width: 100%;
        height: 400px;
    }
    .video-title {
        margin: 10px;
        width: 40%;
        background-color: #000000b3;
        color: #fff;
        text-align: center;
        box-sizing: border-box;
        border: 1px solid #048ff2 ;
    }
    .video-container {
        display: flex;
        justify-content: center;
        flex-direction: column;
        align-items: center;
        width: 100%;
        height: 100%;
    }
    .video-item{
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        margin: 20px;
        width: 100%; 
        margin: 10px auto;
    }
    .button_link{
        margin-top: 40px;
        font-size: 1.5rem;
        background: #5bc1c9;
        height: 80px;
        color: white;
        /* width: 100px; */
        border-radius: 10px;
        border: none;
        width: 40%;
    }
</style>

<body>
    <div class="signaling-p2p-container">
        <div class="video-container">
            <div  class="video-item">  
                <video id="local" autoplay playsinline></video>
                <div class="video-title">æˆ‘</div>
            </div>
            <div class="video-item">
                <video id="remote-video" class="remote-video" autoplay playsinline></video>
                <div class="video-title">è¿œç¨‹è§†é¢‘</div>
            </div>
            
            <button class="button_link" onclick="initConnect()"> ç‚¹æˆ‘å¼€å§‹è¿æ¥</button>
        </div>
        <div class="operation">
            <!-- æˆ¿é—´å·ï¼š
            <input v-model="roomId" style="width: 150px; margin-right: 20px" placeholder="è¦åŠ å…¥çš„æˆ¿é—´å·" clearable
                @keyup.enter="initConnect"></input>
            <button type="primary" @click="initConnect">åŠ å…¥</button>
            <button onclick="handleCamera()">ç‚¹æˆ‘</button>
            <button type="danger" @click="handleLeave">ç¦»å¼€</button> -->
            <!-- <button :type="cameraOpen ? 'warning' : 'primary'" @click="handleMic">
            {{ cameraOpen ? 'å…³é—­' : 'æ‰“å¼€' }}éº¦å…‹é£
          </button> -->
            <!--   <button type="primary" @click="createAnswer(offerSdp)">
            åˆ›å»ºanswer
          </button>
          <button type="primary" @click="addAnswer">æ·»åŠ answer</button> -->
        </div>
    </div>
    <script>
        // åˆ›é€ å¯¹è±¡
        const peerConnection = new RTCPeerConnection({
            // iceServers: [
            //     {
            //         urls: 'stun:stun.voipbuster.com ',
            //     },
            // ],
        })
        const userId = Math.random().toString(36).substring(2)
        console.log(userId)

        // const roomId = ref('3333')
        let roomId = '332'
        let socket
        let localStream
        let remoteStream
        let offerSdp = ''

        // ç¬¬ä¸€æ­¥ï¼šåˆå§‹åŒ–è¿æ¥
        // å®šä¹‰ç›‘å¬äº‹ä»¶
        window.addEventListener('error',(e)=>{
            
        })
        function initConnect() {
            
            if (!roomId) {
                // ElMessage.error('è¯·è¾“å…¥æˆ¿é—´å·')
                alert("è¯·è¾“å…¥æˆ¿é—´å·")
                return
            }
            // socket = io('https://47.95.239.198:3000')
            try{socket = io('https://172.18.91.192:3000')}catch{
alert("å‡ºé”™")
            }
            
            // socket = io('https://signaling.fedtop.com')
            // è¿æ¥æˆåŠŸæ—¶è§¦å‘
            socket.on('connect', () => {
                handleConnect()
            })
            // æ–­å¼€è¿æ¥æ—¶è§¦å‘
            socket.on('disconnect', (reason) => {
                if (reason === 'io server disconnect') {
                    // æ–­çº¿æ˜¯ç”±æœåŠ¡å™¨å‘èµ·çš„ï¼Œé‡æ–°è¿æ¥ã€‚
                    socket.connect()
                }
                console.log("ä½ å·²æ–­å¼€è¿æ¥")
                // ElMessage.warning('æ‚¨å·²æ–­å¼€è¿æ¥')
            })
            // æœåŠ¡ç«¯å‘é€æŠ¥é”™ä¿¡æ¯
            socket.on('error', (data) => {
                console.log("error", data)
                alert(e)
            })
            // å½“æœ‰ç”¨æˆ·åŠ å…¥æˆ¿é—´æ—¶è§¦å‘
            socket.on('welcome', (data) => {
                console.log("welcome", data)
                
                console.log(`ğŸ¦„${data.userId}åŠ å…¥æˆ¿é—´`)
                // alert(`ğŸ¦„${data.userId}åŠ å…¥æˆ¿é—´`)
                // ElMessage.success(data.userId === userId ? 'ğŸ¦„æˆåŠŸåŠ å…¥æˆ¿é—´' : )
            })
            // å½“æœ‰ç”¨æˆ·ç¦»å¼€æˆ¿é—´æ—¶è§¦å‘
            socket.on('leave', (data) => {
               
                console.log(`ğŸ¦„${data.userId}ç¦»å¼€æˆ¿é—´`)
                // ElMessage.warning(data.userId === userId ? 'ğŸ¦„æˆåŠŸç¦»å¼€æˆ¿é—´' : `ğŸ¦„${data.userId}ç¦»å¼€æˆ¿é—´`)
            })
            // å½“æœ‰ç”¨æˆ·å‘é€æ¶ˆæ¯æ—¶è§¦å‘
            socket.on('message', (data) => { })
            // åˆ›å»ºoffer,å‘é€ç»™è¿œç«¯
            socket.on('createOffer', (data) => {
                // å‘é€ offer
                if (offerSdp) {
                    socket.emit('createAnswer', {
                        userId,
                        roomId: roomId,
                        sdp: offerSdp,
                    })
                    return
                }
                createOffer()
            })
            // æ”¶åˆ°offer,åˆ›å»ºanswer
            socket.on('createAnswer', (data) => {
                createAnswer(data.sdp)
            })
            // æ”¶åˆ°answer,è®¾ç½®è¿œç«¯sdp
            socket.on('answer', (data) => {
                addAnswer(data.sdp)
            })
        }


        // initConnect()
        

        // è¿æ¥æˆåŠŸ å‘é€xxåŠ å…¥äº†
        function handleConnect() {
            // é‡è¦å…¨å±€
            socket.emit('join', { userId, roomId: roomId })
        }
        const init = async () => {
            const localVideo = document.getElementById('local')
            const remoteVideo = document.getElementById('remote-video')
            localStream = await navigator.mediaDevices.getUserMedia({
                video: true,
                audio: false,
            })
            remoteStream = new MediaStream()
            localVideo.srcObject = localStream
            remoteVideo.srcObject = remoteStream
            localStream.getTracks().forEach((track) => {
                peerConnection.addTrack(track, localStream)
            })
            peerConnection.ontrack = (event) => {
                event.streams[0].getTracks().forEach((track) => {
                    remoteStream.addTrack(track)
                })
            }
        }
        // åˆ›å»º offer
        async function createOffer() {
            // å½“ä¸€ä¸ªæ–°çš„offer ICEå€™é€‰äººè¢«åˆ›å»ºæ—¶è§¦å‘äº‹ä»¶
            peerConnection.onicecandidate = async (event) => {
                if (event.candidate) {
                    offerSdp = JSON.stringify(peerConnection.localDescription)
                    // å‘é€ offer
                    if (offerSdp) {
                        socket.emit('createAnswer', {
                            userId,
                            roomId: roomId,
                            sdp: offerSdp,
                        })
                    }
                }
            }
            const offer = await peerConnection.createOffer()
            await peerConnection.setLocalDescription(offer)
        }
        // åˆ›å»º answer
        async function createAnswer(val) {
            const offer = JSON.parse(val)
            peerConnection.onicecandidate = async (event) => {
                // å½“ä¸€ä¸ªæ–°çš„ answer ICE candidate è¢«åˆ›å»ºæ—¶
                if (event.candidate) {
                    socket.emit('answer', {
                        userId,
                        roomId: roomId,
                        sdp: JSON.stringify(peerConnection.localDescription),
                    })
                }
            }
            await peerConnection.setRemoteDescription(offer)
            const answer = await peerConnection.createAnswer()
            await peerConnection.setLocalDescription(answer)
        }
        // æ·»åŠ  answer
        async function addAnswer(answerSdp) {
            const answer = JSON.parse(answerSdp)
            if (!peerConnection.currentRemoteDescription) {
                peerConnection.setRemoteDescription(answer)
            }
        }
        // æ‘„åƒå¤´ 
        const cameraOpen = true
        function handleCamera() {
            //   cameraOpen.value = !cameraOpen.value
            localStream.getVideoTracks().forEach((track) => {
                track.enabled = true
            })
        }
        // // å¼€å…³éº¦å…‹é£
        // const isAudioOpen = ref(true)
        // function handleMic() {
        //   localStream.getAudioTracks().forEach((track) => {
        //     track.stop()
        //   })
        //   isAudioOpen.value = !isAudioOpen.value
        // }
        // ç¦»å¼€æˆ¿é—´
        function handleLeave() {
            // å…³é—­å¯¹ç­‰è¿æ¥
            peerConnection.close()
            // å‘é€ç¦»å¼€çš„æ¶ˆæ¯
            socket.emit('leave', { userId, roomId: roomId })
            // å…³é—­socketè¿æ¥
            socket.disconnect()
        }
        init()
    </script>
</body>

</html>