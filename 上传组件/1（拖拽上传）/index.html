<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Drag&Drop File Uploader</title>
    <link rel="stylesheet" href="./style.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            width: 100vw;
            height: 100vh;
            display: grid;
            place-items: center;
            font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        }

        .dnd-file-uploader {
            width: 90vw;
        }

        .drop-area {
            height: 50vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 20px;
            color: #8c8c8c;
            border: 6px dashed #bfbfbf;
            border-radius: 16px;
            user-select: none;
        }

        .upload-icon {
            color: #40a9ff;
            font-size: 10rem;
        }

        .tip {
            font-size: 2rem;
        }

        .task-list {
            height: 40vh;
            margin-top: 20px;
            overflow: auto;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .task {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 24px;
            color: #333;
            padding: 16px;
            position: relative;
        }
    </style>
</head>

<body>

    <div class="dnd-file-uploader">
        <div class="drop-area" draggable="true">
            <ion-icon class="upload-icon" name="cloud-upload"></ion-icon>
            <p class="tip">Drag&Drop files here</p>
        </div>
        <div class="task-list"></div>
    </div>

    <template id="template-task">
        <div class="task">
            <a class="task-name" target="_blank">some file name</a>
            <span class="task-progress">50%</span>
        </div>
    </template>

    <script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>
    <script>
        const TASK_STATUS = {
            PROCESSING: 1,
            SUCCESS: 2,
            ERROR: 3,
        }

        class FileUploader {
            constructor({
                element,
                uploadUrl,
                taskRenderer
            }) {
                if (element instanceof HTMLElement) {
                    this.element = element;
                } else {
                    throw new Error('element should be an HTMLElement')
                }
                this.uploadUrl = uploadUrl;
                this.taskRenderer = taskRenderer;
                this.init();
            }

            // public props
            tasks = [];

            // private methods
            init = () => {
                this.listenToEvents();
            }

            listenToEvents = () => {
                const dropAreaDOM = this.element.querySelector('.drop-area');
                dropAreaDOM.addEventListener('drop', this.handleDrop);
                dropAreaDOM.addEventListener('dragover', this.handleDragover);
            }

            handleDrop = (e) => {
                // Prevent file from being opened
                e.preventDefault();
                if (e.dataTransfer.items) {
                    // Use DataTransferItemList interface to access files
                    for (const item of e.dataTransfer.items) {
                        if (item.kind === 'file') {
                            const file = item.getAsFile();
                            console.log('file: ', file);
                            this.upload(file);
                        }
                    }
                } else {
                    // Use DataTransfer interface to access the files
                    for (const file of e.dataTransfer.files) {
                        console.log('file: ', file);
                        this.upload(file);
                    }
                }
            }

            handleDragover = (e) => {
                // Prevent file from being opened
                e.preventDefault();
            }

            upload = (file) => {
                const data = new FormData();
                data.append('file', file);
                const task = {
                    id: this.tasks.length,
                    name: file.name,
                    status: TASK_STATUS.PROCESSING,
                    progress: 0
                }
                this.tasks.unshift(task);
                const xhr = new XMLHttpRequest();
                xhr.open('POST', this.uploadUrl);
                xhr.setRequestHeader('x-file-name', encodeURIComponent(file.name));
                xhr.upload.addEventListener('progress', (e) => {
                    const { loaded, total } = e;
                    const progress = Math.round(loaded / total * 100);
                    task.progress = progress;
                    this.updateTask(task);
                });
                xhr.addEventListener('load', (e) => {
                    task.status = TASK_STATUS.SUCCESS;
                    const response = JSON.parse(xhr.response);
                    console.log('response', response);
                    const { url } = response;
                    task.url = url;
                    this.updateTask(task);
                });
                xhr.addEventListener('error', (e) => {
                    task.status = TASK_STATUS.ERROR;
                    this.updateTask(task);
                });
                xhr.send(data);
            }

            updateTask = (task) => {
                const taskList = this.element.querySelector('.task-list');
                const id = `task-${task.id}`;
                let taskBox = taskList.querySelector(`#${id}`);
                if (!taskBox) {
                    taskBox = document.createElement('div');
                    taskBox.id = id;
                    taskList.prepend(taskBox);
                }
                taskBox.innerHTML = '';
                taskBox.append(this.taskRenderer(task));
            }
        }

        const taskTemplate = document.querySelector('#template-task');

        new FileUploader({
            element: document.querySelector('.dnd-file-uploader'),
            uploadUrl: 'http://localhost:3000/upload',
            taskRenderer: function (task) {
                const taskDOM = taskTemplate.content.firstElementChild.cloneNode(true);
                const nameDOM = taskDOM.querySelector('.task-name');
                nameDOM.textContent = task.name;
                const progressDOM = taskDOM.querySelector('.task-progress');
                const progress = `${task.progress}%`
                progressDOM.textContent = progress;
                if (task.status === TASK_STATUS.PROCESSING) {
                    taskDOM.style.background = `linear-gradient(to right, #bae7ff ${progress}, #fafafa ${progress}, #fafafa 100%)`
                } else if (task.status === TASK_STATUS.SUCCESS) {
                    taskDOM.style.background = '#d9f7be';
                    nameDOM.href = task.url;
                } else if (task.status === TASK_STATUS.ERROR) {
                    taskDOM.style.background = '#ffccc7';
                }
                return taskDOM;
            }
        });


    </script>

</body>


</html>